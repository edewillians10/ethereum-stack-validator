#!/usr/bin/env python3
import argparse
import json
import os
import urllib.parse
import urllib.request
from http.server import BaseHTTPRequestHandler, HTTPServer


BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "")
CHAT_ID = os.environ.get("TELEGRAM_CHAT_ID", "")


def send_message(text):
    if not BOT_TOKEN or not CHAT_ID:
        return
    data = urllib.parse.urlencode({"chat_id": CHAT_ID, "text": text}).encode()
    req = urllib.request.Request(
        "https://api.telegram.org/bot{}/sendMessage".format(BOT_TOKEN),
        data=data,
    )
    try:
        urllib.request.urlopen(req, timeout=10)
    except Exception:
        pass


def format_alert(alert):
    status = alert.get("status", "unknown").upper()
    labels = alert.get("labels", {})
    annotations = alert.get("annotations", {})
    summary = annotations.get("summary", labels.get("alertname", "Alert"))
    description = annotations.get("description", "")
    instance = labels.get("instance", "")
    message = "[{}] {}".format(status, summary)
    if instance:
        message += "\ninstance: {}".format(instance)
    if description:
        message += "\n{}".format(description)
    return message


class AlertHandler(BaseHTTPRequestHandler):
    def do_POST(self):
        length = int(self.headers.get("Content-Length", "0"))
        body = self.rfile.read(length) if length else b""
        try:
            payload = json.loads(body.decode("utf-8"))
        except Exception:
            payload = {}
        alerts = payload.get("alerts", [])
        if isinstance(alerts, list):
            for alert in alerts:
                send_message(format_alert(alert))
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"ok")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--host", default="{{ alertmanager_webhook_bind }}")
    parser.add_argument("--port", type=int, default={{ alertmanager_webhook_port }})
    args = parser.parse_args()
    server = HTTPServer((args.host, args.port), AlertHandler)
    server.serve_forever()


if __name__ == "__main__":
    main()
