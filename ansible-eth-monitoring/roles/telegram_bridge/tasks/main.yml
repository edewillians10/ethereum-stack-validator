- name: Assert Telegram credentials are set
  assert:
    that:
      - telegram_bot_token | length > 0
      - telegram_chat_id | length > 0
    fail_msg: "Defina telegram_bot_token e telegram_chat_id em group_vars/all.yml."

- name: Ensure alert bridge directory exists
  file:
    path: /opt/eth-monitoring
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install alert bridge script
  template:
    src: telegram-alert-bridge.py.j2
    dest: /opt/eth-monitoring/telegram-alert-bridge.py
    mode: "0755"
  notify: restart telegram alert bridge

- name: Configure alert bridge environment
  template:
    src: telegram-alert-bridge.env.j2
    dest: /etc/default/telegram-alert-bridge
    mode: "0640"
  notify: restart telegram alert bridge

- name: Install alert bridge systemd unit
  template:
    src: telegram-alert-bridge.service.j2
    dest: /etc/systemd/system/telegram-alert-bridge.service
    mode: "0644"
  notify:
    - reload systemd
    - restart telegram alert bridge

- name: Enable and start alert bridge service
  systemd:
    name: telegram-alert-bridge
    enabled: yes
    state: started
