- name: Ensure Prometheus config exists
  stat:
    path: "{{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}"
  register: prometheus_config

- name: Fail if Prometheus config is missing
  fail:
    msg: "Prometheus config not found at {{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}."
  when: not prometheus_config.stat.exists

- name: Configure Prometheus alertmanager target
  blockinfile:
    path: "{{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}"
    marker: "# {mark} ANSIBLE ALERTMANAGER"
    insertbefore: "^scrape_configs:"
    block: |
      alerting:
        alertmanagers:
          - static_configs:
              - targets:
                  - "{{ alertmanager_listen_address | default('127.0.0.1') }}:{{ alertmanager_port | default(9093) }}"
  notify: restart prometheus

- name: Ensure Prometheus rules directory exists
  file:
    path: "{{ prometheus_rules_dir | default('/etc/prometheus/rules') }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install custom alert rules
  template:
    src: eth-monitoring.rules.yml.j2
    dest: "{{ prometheus_rules_dir | default('/etc/prometheus/rules') }}/eth-monitoring.rules.yml"
    mode: "0644"
  notify: restart prometheus

- name: Fix duplicate rule_files header from previous runs
  replace:
    path: "{{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}"
    regexp: "rule_files:\\n# BEGIN ANSIBLE ETH MONITORING RULES\\nrule_files:"
    replace: "# BEGIN ANSIBLE ETH MONITORING RULES"
  notify: restart prometheus

- name: Remove stale rule_files lines from previous runs
  lineinfile:
    path: "{{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}"
    regexp: "^(rule_files:|  - /etc/prometheus/rules/eth-(monitoring|validator)\\.rules\\.yml)$"
    state: absent

- name: Ensure Prometheus includes custom rules
  blockinfile:
    path: "{{ prometheus_config_path | default('/etc/prometheus/prometheus.yml') }}"
    marker: "# {mark} ANSIBLE ETH MONITORING RULES"
    insertbefore: "^scrape_configs:"
    block: |
      rule_files:
        - {{ prometheus_rules_dir | default('/etc/prometheus/rules') }}/eth-monitoring.rules.yml
        - {{ prometheus_rules_dir | default('/etc/prometheus/rules') }}/eth-validator.rules.yml
  notify: restart prometheus
