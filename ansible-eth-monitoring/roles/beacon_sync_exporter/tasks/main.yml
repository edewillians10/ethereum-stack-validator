- name: Ensure node exporter textfile directory exists
  ansible.builtin.file:
    path: "{{ node_exporter_textfile_dir }}"
    state: directory
    owner: prometheus
    group: prometheus
    mode: "0755"
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Ensure node exporter defaults include textfile directory
  ansible.builtin.lineinfile:
    path: /etc/default/prometheus-node-exporter
    regexp: '^ARGS='
    line: 'ARGS="--collector.textfile.directory={{ node_exporter_textfile_dir }}"'
    create: true
  notify: restart node exporter
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Ensure eth monitoring directory exists
  ansible.builtin.file:
    path: /opt/eth-monitoring
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Install beacon sync exporter script
  ansible.builtin.template:
    src: beacon-sync-exporter.py.j2
    dest: /opt/eth-monitoring/beacon-sync-exporter.py
    owner: root
    group: root
    mode: "0755"
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Install beacon sync exporter systemd service
  ansible.builtin.template:
    src: eth-beacon-sync-exporter.service.j2
    dest: /etc/systemd/system/eth-beacon-sync-exporter.service
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Install beacon sync exporter systemd timer
  ansible.builtin.template:
    src: eth-beacon-sync-exporter.timer.j2
    dest: /etc/systemd/system/eth-beacon-sync-exporter.timer
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter

- name: Enable and start beacon sync exporter timer
  ansible.builtin.systemd:
    name: eth-beacon-sync-exporter.timer
    enabled: true
    state: started
  when: beacon_sync_exporter_enabled
  tags: beacon_sync_exporter
