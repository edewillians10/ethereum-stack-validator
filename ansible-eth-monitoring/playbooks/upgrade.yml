- name: Ethereum Client Upgrade
  hosts: ethereum
  become: true

  vars:
    nethermind_download_url: ""
    lighthouse_download_url: ""

  tasks:
    - name: Fetch latest Nethermind release metadata
      uri:
        url: "https://api.github.com/repos/NethermindEth/nethermind/releases/latest"
        return_content: true
      register: nethermind_release
      when: nethermind_download_url | length == 0

    - name: Select Nethermind asset URL
      set_fact:
        nethermind_download_url: "{{ (nethermind_release.json.assets | selectattr('name', 'search', 'linux-x64.zip') | map(attribute='browser_download_url') | list | first) | default('') }}"
      when: nethermind_download_url | length == 0

    - name: Fetch latest Lighthouse release metadata
      uri:
        url: "https://api.github.com/repos/sigp/lighthouse/releases/latest"
        return_content: true
      register: lighthouse_release
      when: lighthouse_download_url | length == 0

    - name: Select Lighthouse asset URL
      set_fact:
        lighthouse_download_url: "{{ (lighthouse_release.json.assets | selectattr('name', 'search', 'x86_64-unknown-linux-gnu.tar.gz') | map(attribute='browser_download_url') | list | first) | default('') }}"
      when: lighthouse_download_url | length == 0

    - name: Assert upgrade URLs are set
      assert:
        that:
          - nethermind_download_url | length > 0
          - lighthouse_download_url | length > 0
        fail_msg: "Defina nethermind_download_url e lighthouse_download_url (ou permita buscar latest do GitHub)."

    - name: Create upgrade working directory
      file:
        path: /tmp/eth-upgrade
        state: directory
        mode: "0755"

    - name: Create Nethermind extract directory
      file:
        path: /tmp/eth-upgrade/nethermind
        state: directory
        mode: "0755"

    - name: Download Nethermind release
      get_url:
        url: "{{ nethermind_download_url }}"
        dest: /tmp/eth-upgrade/nethermind.zip
        mode: "0644"

    - name: Extract Nethermind
      unarchive:
        src: /tmp/eth-upgrade/nethermind.zip
        dest: /tmp/eth-upgrade/nethermind
        remote_src: yes

    - name: Find Nethermind binary
      find:
        paths: /tmp/eth-upgrade/nethermind
        patterns: nethermind
        file_type: file
      register: nethermind_found

    - name: Install Nethermind binary
      copy:
        src: "{{ nethermind_found.files[0].path }}"
        dest: /opt/nethermind/nethermind
        owner: root
        group: root
        mode: "0755"
        remote_src: yes

    - name: Download Lighthouse release
      get_url:
        url: "{{ lighthouse_download_url }}"
        dest: /tmp/eth-upgrade/lighthouse.tar.gz
        mode: "0644"

    - name: Create Lighthouse extract directory
      file:
        path: /tmp/eth-upgrade/lighthouse
        state: directory
        mode: "0755"

    - name: Extract Lighthouse
      unarchive:
        src: /tmp/eth-upgrade/lighthouse.tar.gz
        dest: /tmp/eth-upgrade/lighthouse
        remote_src: yes

    - name: Find Lighthouse binary
      find:
        paths: /tmp/eth-upgrade/lighthouse
        patterns: lighthouse
        file_type: file
      register: lighthouse_found

    - name: Install Lighthouse binary
      copy:
        src: "{{ lighthouse_found.files[0].path }}"
        dest: /opt/lighthouse/lighthouse
        owner: root
        group: root
        mode: "0755"
        remote_src: yes

    - name: Restart services after upgrade
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - nethermind
        - lighthouse-beacon
        - lighthouse-validator
