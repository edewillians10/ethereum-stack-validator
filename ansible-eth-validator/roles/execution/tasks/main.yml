- name: create nethermind directory
  file:
    path: "{{ nethermind_base_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: execution

- name: download nethermind release
  get_url:
    url: "{{ nethermind_download_url }}"
    dest: "/tmp/nethermind-{{ nethermind_version }}.zip"
    mode: "0644"
    checksum: "{{ nethermind_checksum | default(omit) }}"
  tags: execution

- name: create nethermind extract directory
  file:
    path: "{{ nethermind_extract_dir }}"
    state: directory
    mode: "0755"
  tags: execution

- name: unarchive nethermind
  unarchive:
    src: "/tmp/nethermind-{{ nethermind_version }}.zip"
    dest: "{{ nethermind_extract_dir }}"
    remote_src: yes
  tags: execution

- name: find nethermind binary
  find:
    paths: "{{ nethermind_extract_dir }}"
    patterns: nethermind
    file_type: file
  register: nethermind_found
  tags: execution

- name: fail if nethermind binary not found
  fail:
    msg: "Nethermind binary not found after extraction"
  when: nethermind_found.matched == 0
  tags: execution

- name: install nethermind binary to final location
  copy:
    src: "{{ nethermind_found.files[0].path }}"
    dest: "{{ nethermind_bin }}"
    owner: root
    group: root
    mode: "0755"
    remote_src: yes
  tags: execution


- name: ensure execution data directory ownership
  file:
    path: "{{ execution_dir }}"
    state: directory
    owner: "{{ execution_user }}"
    group: "{{ execution_group }}"
    recurse: yes
  tags: execution

- name: check jwt secret file
  stat:
    path: "{{ jwt_secret_path }}"
  register: jwt_stat
  tags: execution

- name: read jwt secret file
  slurp:
    path: "{{ jwt_secret_path }}"
  register: jwt_slurp
  when: jwt_stat.stat.exists
  tags: execution

- name: validate jwt secret
  set_fact:
    jwt_secret_valid: "{{ (jwt_slurp.content | b64decode | trim) is match('^[0-9a-fA-F]{64}$') }}"
  when: jwt_stat.stat.exists
  tags: execution

- name: generate jwt secret when missing or invalid
  command: openssl rand -hex 32
  register: jwt_secret
  when: (not jwt_stat.stat.exists) or (jwt_secret_valid is defined and not jwt_secret_valid)
  tags: execution

- name: write jwt secret
  copy:
    dest: "{{ jwt_secret_path }}"
    content: "{{ jwt_secret.stdout | trim }}"
    owner: execution
    group: ethereum
    mode: "0640"
  when: jwt_secret.stdout is defined
  tags: execution



- name: install nethermind systemd service
  template:
    src: nethermind.service.j2
    dest: /etc/systemd/system/nethermind.service
    mode: "0644"
  notify:
    - reload systemd
    - restart nethermind
  tags: execution

- name: enable nethermind service
  systemd:
    name: nethermind
    enabled: yes
    state: started
  tags: execution

- name: restart clients after jwt rotation
  systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - nethermind
    - lighthouse-beacon
  when: jwt_secret.stdout is defined
  tags: execution

- name: set jwt permissions for execution and consensus
  file:
    path: "{{ jwt_secret_path }}"
    owner: execution
    group: ethereum
    mode: "0640"
  tags: execution
