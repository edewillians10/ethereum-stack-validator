- name: update apt cache for monitoring packages
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: monitoring

- name: assert alertmanager webhook when enabled
  assert:
    that:
      - monitoring_alertmanager_webhook_url | length > 0
    fail_msg: "Defina monitoring_alertmanager_webhook_url para habilitar o Alertmanager."
  when: monitoring_alertmanager_enabled | default(false)
  tags: monitoring

- name: install prometheus and node exporter
  apt:
    name:
      - gnupg
      - prometheus
      - prometheus-node-exporter
    state: present
  tags: monitoring

- name: ensure prometheus rules directory exists
  file:
    path: /etc/prometheus/rules
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: monitoring

- name: configure prometheus defaults
  template:
    src: prometheus-defaults.j2
    dest: /etc/default/prometheus
    mode: "0644"
  notify: restart prometheus
  tags: monitoring

- name: configure node exporter defaults
  template:
    src: node-exporter-defaults.j2
    dest: /etc/default/prometheus-node-exporter
    mode: "0644"
  notify: restart node exporter
  tags: monitoring

- name: install prometheus alert rules
  template:
    src: eth-validator.rules.yml.j2
    dest: /etc/prometheus/rules/eth-validator.rules.yml
    mode: "0644"
  notify: restart prometheus
  tags: monitoring

- name: configure prometheus scrape targets
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    mode: "0644"
  notify: restart prometheus
  tags: monitoring

- name: install alertmanager (optional)
  apt:
    name: alertmanager
    state: present
  when: monitoring_alertmanager_enabled | default(false)
  tags: monitoring

- name: configure alertmanager defaults
  template:
    src: alertmanager-defaults.j2
    dest: /etc/default/alertmanager
    mode: "0644"
  notify: restart alertmanager
  when: monitoring_alertmanager_enabled | default(false)
  tags: monitoring

- name: configure alertmanager routing
  template:
    src: alertmanager.yml.j2
    dest: /etc/alertmanager/alertmanager.yml
    mode: "0644"
  notify: restart alertmanager
  when: monitoring_alertmanager_enabled | default(false)
  tags: monitoring

- name: ensure alertmanager service is enabled and started
  systemd:
    name: alertmanager
    enabled: yes
    state: started
  when: monitoring_alertmanager_enabled | default(false)
  tags: monitoring

- name: ensure prometheus service is enabled and started
  systemd:
    name: prometheus
    enabled: yes
    state: started
  tags: monitoring

- name: ensure node exporter service is enabled and started
  systemd:
    name: prometheus node exporter
    enabled: yes
    state: started
  tags: monitoring

- name: install grafana (optional)
  block:
    - name: ensure grafana keyring directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: download grafana repository key
      get_url:
        url: https://apt.grafana.com/gpg.key
        dest: /tmp/grafana.gpg.key
        mode: "0644"

    - name: install grafana repository key
      command: gpg --dearmor -o /etc/apt/keyrings/grafana.gpg /tmp/grafana.gpg.key
      args:
        creates: /etc/apt/keyrings/grafana.gpg

    - name: add grafana apt repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
        state: present

    - name: install grafana package
      apt:
        name: grafana
        update_cache: yes
        state: present
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: configure grafana settings
  ini_file:
    path: /etc/grafana/grafana.ini
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  loop:
    - { section: "server", option: "http_port", value: "{{ monitoring_grafana_port }}" }
    - { section: "server", option: "domain", value: "{{ monitoring_grafana_domain }}" }
    - { section: "server", option: "root_url", value: "{{ monitoring_grafana_root_url }}" }
    - { section: "security", option: "admin_user", value: "{{ monitoring_grafana_admin_user }}" }
    - { section: "security", option: "admin_password", value: "{{ monitoring_grafana_admin_password }}" }
  notify: restart grafana
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: ensure grafana provisioning directories exist
  file:
    path: "{{ item }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"
  loop:
    - /etc/grafana/provisioning/datasources
    - /etc/grafana/provisioning/dashboards
    - /var/lib/grafana/dashboards
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: configure grafana datasource provisioning
  template:
    src: grafana-datasource.yml.j2
    dest: /etc/grafana/provisioning/datasources/eth-validator.yml
    mode: "0644"
    owner: grafana
    group: grafana
  notify: restart grafana
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: configure grafana dashboard provisioning
  template:
    src: grafana-dashboards.yml.j2
    dest: /etc/grafana/provisioning/dashboards/eth-validator.yml
    mode: "0644"
    owner: grafana
    group: grafana
  notify: restart grafana
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: install grafana dashboard
  template:
    src: dashboards/eth-validator.json.j2
    dest: /var/lib/grafana/dashboards/eth-validator.json
    mode: "0644"
    owner: grafana
    group: grafana
  notify: restart grafana
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: ensure grafana service is enabled and started
  systemd:
    name: grafana server
    enabled: yes
    state: started
  when: monitoring_grafana_enabled | default(false)
  tags: monitoring

- name: flush handlers to reload updated service units
  meta: flush_handlers

- name: restart clients to apply metrics settings
  systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - nethermind
    - lighthouse-beacon
    - lighthouse-validator
  when: monitoring_enabled | default(false)
  tags: monitoring

- name: wait for metrics endpoints
  wait_for:
    host: 127.0.0.1
    port: "{{ item }}"
    state: started
    delay: 2
    timeout: 60
  loop:
    - "{{ nethermind_metrics_port | default(6060) }}"
    - "{{ lighthouse_beacon_metrics_port | default(5054) }}"
    - "{{ lighthouse_validator_metrics_port | default(5064) }}"
  when: monitoring_enabled | default(false)
  tags: monitoring
  failed_when: false
