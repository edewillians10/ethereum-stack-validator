- name: Ethereum Validator Node (Holesky)
  hosts: ethereum
  become: true

  roles:
    - base
    - execution
    - consensus
    - validator

  tasks:
    - name: Run MEV-Boost role when enabled
      include_role:
        name: mev_boost
      when: mev_enabled | default(false)

    - name: Run monitoring role when enabled
      include_role:
        name: monitoring
      when: monitoring_enabled | default(false)

  post_tasks:
    - name: Wait for beacon API to be reachable
      wait_for:
        host: "{{ beacon_api_host | default('127.0.0.1') }}"
        port: "{{ beacon_api_port | default(5052) }}"
        state: started
        delay: 2
        timeout: 60
      failed_when: false

    - name: Check beacon sync status
      uri:
        url: "http://{{ beacon_api_host | default('127.0.0.1') }}:{{ beacon_api_port | default(5052) }}/eth/v1/node/syncing"
        return_content: true
        status_code: 200
      register: beacon_sync_status
      failed_when: false

    - name: Report beacon sync status
      debug:
        msg: "Beacon syncing: {{ beacon_sync_status.json.data.is_syncing | default('unknown') }}"

    - name: Wait for beacon sync to complete
      uri:
        url: "http://{{ beacon_api_host | default('127.0.0.1') }}:{{ beacon_api_port | default(5052) }}/eth/v1/node/syncing"
        return_content: true
        status_code: 200
      register: beacon_sync_wait
      until: beacon_sync_wait.json.data.is_syncing == false
      retries: "{{ (beacon_wait_timeout | int // beacon_wait_delay | int) | max(1) }}"
      delay: "{{ beacon_wait_delay }}"
      when: beacon_wait_for_sync | default(false)
